<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Hotel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <h2>Edit Hotel</h2>
  <form id="editHotelForm">
    <input type="hidden" id="hotelId">
    <div class="mb-3">
      <input type="text" id="title" class="form-control" placeholder="Title" required />
    </div>
    <div class="mb-3">
      <input type="text" id="category" class="form-control" placeholder="Category" required />
    </div>
    <div class="mb-3">
      <input type="number" id="price" class="form-control" placeholder="Price per Night" required />
    </div>
    <div class="mb-3">
      <input type="number" step="0.1" id="rating" class="form-control" placeholder="Rating" required />
    </div>
    <div class="mb-3">
      <textarea id="description" class="form-control" placeholder="Description"></textarea>
    </div>
    <div class="mb-3">
      <input type="file" id="image" class="form-control" />
    </div>
    <button type="submit" class="btn btn-primary">Update Hotel</button>
    <a href="dashboard.html" class="btn btn-secondary">Cancel</a>
  </form>
</div>
<script>
  const token = localStorage.getItem('token');
  if (!token) {
    alert('You are not logged in');
    window.location.href = 'login.html';
  }

  let ckEditorInstance;
    ClassicEditor.create(document.querySelector('#description'))
    .then(editor => {
        ckEditorInstance = editor;
        loadHotel(); // Load data after editor is ready
    })
    .catch(error => console.error(error));

  // Get hotel ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const hotelId = urlParams.get('id');
  document.getElementById('hotelId').value = hotelId;

  // Fetch hotel data and populate form
  async function loadHotel() {
    const res = await fetch(`http://127.0.0.1:8000/api/hotels/${hotelId}`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/json'
      }
    });
    if (res.ok) {
      const data = await res.json();
      document.getElementById('title').value = data.title;
      document.getElementById('category').value = data.category;
      document.getElementById('price').value = data.price_per_night;
      document.getElementById('rating').value = data.rating;
      ckEditorInstance.setData(data.description);
    } else {
      alert('Failed to load hotel data');
      window.location.href = 'dashboard.html';
    }
  }

  // Handle form submission
  document.getElementById('editHotelForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append('title', document.getElementById('title').value);
  formData.append('description', ckEditorInstance.getData());
  formData.append('category', document.getElementById('category').value);
  formData.append('price_per_night', document.getElementById('price').value);
  formData.append('rating', parseFloat(document.getElementById('rating').value));
  const image = document.getElementById('image').files[0];
  if (image) formData.append('image', image);

  formData.append('_method', 'PUT');

  const res = await fetch(`http://127.0.0.1:8000/api/hotels/${hotelId}`, {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/json'
    },
    body: formData
  });

  if (res.ok) {
    alert('Hotel updated!');
    window.location.href = 'dashboard.html';
  } else {
    const errorData = await res.json();
    if (errorData.errors) {
      alert(Object.values(errorData.errors).flat().join('\n'));
    } else {
      alert('Update failed.');
    }
    console.error(errorData);
  }
});
</script>
</body>
</html>